{% extends "base.html" %}
{% block title %}Chatbot{% endblock %}
{% block content %}
<div id="chatbot-container" class="chatbot-container">
    <header class="chatbot-header">
        <h1>Chatbot</h1>
    </header>
    <main id="chat-container" class="chat-messages"></main>
    <footer class="chat-input-container">
        <form id="chat-form" class="chat-form">
            <div id="file-preview" class="file-preview"></div>
            <input type="text" id="user-input" class="chat-input" placeholder="Type your message...">
            <label for="file-upload" class="attachment-icon">ðŸ“Ž</label>
            <input id="file-upload" type="file" accept="image/*,.txt,.pdf,.doc,.docx" style="display: none;">
            <button type="submit" class="chat-submit">Send</button>
        </form>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/atom-one-dark.min.css">
<script>
const chatbotContainer = document.getElementById('chatbot-container');
const chatContainer = document.getElementById('chat-container');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const fileUpload = document.getElementById('file-upload');
const filePreview = document.getElementById('file-preview');
let currentFileData = null;
let currentFileType = null;

function adjustLayout() {
    const viewportHeight = window.innerHeight;
    chatbotContainer.style.height = `${viewportHeight}px`;
    const headerHeight = document.querySelector('.chatbot-header').offsetHeight;
    const footerHeight = document.querySelector('.chat-input-container').offsetHeight;
    chatContainer.style.height = `${viewportHeight - headerHeight - footerHeight}px`;
}

window.addEventListener('load', adjustLayout);
window.addEventListener('resize', adjustLayout);

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = userInput.value.trim();
    if (message || currentFileData) {
        appendMessage('You', message, currentFileData, currentFileType);
        fetchBotResponse(message, currentFileData, currentFileType);
        userInput.value = '';
        clearFilePreview();
    }
});

fileUpload.addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentFileData = e.target.result.split(',')[1];
            currentFileType = file.type.startsWith('image/') ? 'image' : 'document';
            displayFilePreview(file.name, currentFileType);
        };
        reader.readAsDataURL(file);
    }
}

function displayFilePreview(fileName, fileType) {
    if (fileType === 'image') {
        filePreview.innerHTML = `<img src="data:image/jpeg;base64,${currentFileData}" alt="Uploaded image" style="max-width: 100px; max-height: 100px;">`;
    } else {
        filePreview.innerHTML = `<span>${fileName}</span>`;
    }
}

function clearFilePreview() {
    filePreview.innerHTML = '';
    currentFileData = null;
    currentFileType = null;
}

chatContainer.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
});

chatContainer.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const file = e.dataTransfer.files[0];
    fileUpload.files = e.dataTransfer.files;
    handleFileSelect({ target: fileUpload });
});

function appendMessage(sender, message, fileData = null, fileType = null) {
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${sender.toLowerCase()}`;
    
    const senderElement = document.createElement('div');
    senderElement.className = 'sender';
    senderElement.textContent = sender;
    messageElement.appendChild(senderElement);

    const contentElement = document.createElement('div');
    contentElement.className = 'content prose';
    
    if (sender === 'You') {
        contentElement.textContent = message;
        if (fileData) {
            if (fileType === 'image') {
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${fileData}`;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                contentElement.appendChild(img);
            } else {
                const docInfo = document.createElement('p');
                docInfo.textContent = 'Document attached';
                contentElement.appendChild(docInfo);
            }
        }
    } else {
        contentElement.innerHTML = marked.parse(message);
        contentElement.querySelectorAll('pre code').forEach((block) => {
            const pre = block.parentNode;
            hljs.highlightBlock(block);
            addCopyButton(pre, block);
        });
    }
    
    messageElement.appendChild(contentElement);
    chatContainer.appendChild(messageElement);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return contentElement;
}

function addCopyButton(pre, block) {
    const copyButton = document.createElement('button');
    copyButton.textContent = 'Copy';
    copyButton.className = 'copy-button';
    copyButton.addEventListener('click', () => {
        navigator.clipboard.writeText(block.textContent).then(() => {
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = 'Copy';
            }, 2000);
        });
    });
    pre.appendChild(copyButton);
}
   
function fetchBotResponse(message, fileData = null, fileType = null) {
    const botMessageElement = appendMessage('Bot', '');
    const formData = new FormData();
    formData.append('user_input', message);
    if (fileData) {
        if (fileType === 'image') {
            formData.append('image_data', fileData);
        } else {
            formData.append('document_data', fileData);
        }
    }

    fetch('/stream', {
        method: 'POST',
        body: formData
    }).then(response => {
        const reader = response.body.getReader();
        let fullMessage = '';

        function readChunk() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    console.log("Stream complete");
                    return;
                }

                const chunk = new TextDecoder().decode(value);
                const lines = chunk.split('\n\n');
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        if (data.type === 'message_delta') {
                            console.log("Message complete");
                        } else if (data.error) {
                            console.error("Server error:", data.error);
                            botMessageElement.innerHTML = `Error: ${data.error}`;
                        } else if (data.text) {
                            fullMessage += data.text;
                            botMessageElement.innerHTML = marked.parse(fullMessage);
                            botMessageElement.querySelectorAll('pre code').forEach((block) => {
                                const pre = block.parentNode;
                                hljs.highlightBlock(block);
                                addCopyButton(pre, block);
                            });
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    }
                });

                readChunk();
            }).catch(error => {
                console.error("Error reading stream:", error);
                botMessageElement.innerHTML = 'Error: Connection lost. Please try again.';
            });
        }

        readChunk();
    }).catch(error => {
        console.error("Fetch error:", error);
        botMessageElement.innerHTML = 'Error: Failed to connect to the server. Please try again.';
    });
}
</script>
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    body {
        display: flex;
        flex-direction: column;
    }

    .chatbot-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        max-height: 100vh;
        overflow: hidden;
    }

    .chatbot-header {
        flex: 0 0 auto;
        padding: 0.5rem 1rem;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
    }

    .chatbot-header h1 {
        margin: 0;
        font-size: 1.5rem;
    }

    .chat-messages {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 1rem;
        background-color: #ffffff;
    }

    .chat-input-container {
        flex: 0 0 auto;
        padding: 0.5rem 1rem;
        background-color: #f0f0f0;
        border-top: 1px solid #ddd;
    }

    .chat-form {
        display: flex;
        width: 100%;
        align-items: center;
    }

    .chat-input {
        flex-grow: 1;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 0.5rem;
    }

    .attachment-icon {
        cursor: pointer;
        font-size: 1.5rem;
        margin-right: 0.5rem;
    }

    .chat-submit {
        padding: 0.5rem 1rem;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .chat-message {
        max-width: 70%;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
    }

    .chat-message.you {
        margin-left: auto;
        background-color: #e3f2fd;
    }

    .chat-message.bot {
        margin-right: auto;
        background-color: #f0f0f0;
    }

    .prose pre {
        position: relative;
        margin-top: 1.5em;
        background-color: #282c34;
        border-radius: 6px;
        overflow: hidden;
    }

    .prose pre code {
        display: block;
        padding: 1em;
        overflow-x: auto;
        color: #abb2bf;
    }

    .copy-button {
        position: absolute;
        top: 0.25em;
        right: 0.5em;
        padding: 0.25em 0.5em;
        background-color: #3e4451;
        color: #abb2bf;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75em;
    }

    .copy-button:hover {
        background-color: #4b5363;
    }

    .file-preview {
        display: flex;
        align-items: center;
        margin-right: 0.5rem;
    }

    .file-preview img {
        max-width: 50px;
        max-height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }

    .file-preview span {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.8rem;
        color: #555;
    }
</style>
{% endblock %}